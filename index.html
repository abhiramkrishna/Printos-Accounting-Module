<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printos Accounting - Python Engine</title>
    
    <!-- Tailwind CSS & DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#151e2e',
                            900: '#0f172a'
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Brython -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.12.0/brython.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.12.0/brython_stdlib.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        
        .transition-all-300 { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        #slide-over-panel { transition: transform 0.3s ease-in-out; }
        #slide-over-panel.open { transform: translateX(0); }
        #slide-over-panel.closed { transform: translateX(100%); }
        
        .fab-container { position: absolute; bottom: 2rem; right: 2rem; z-index: 40; }
        .fab-menu { 
            position: absolute; bottom: 4.5rem; right: 0; 
            display: flex; flex-direction: column; gap: 0.5rem; 
            align-items: flex-end; 
            opacity: 0; pointer-events: none; transform: translateY(10px);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .fab-menu.active { opacity: 1; pointer-events: auto; transform: translateY(0); }

        .view-section { display: none; opacity: 0; animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .view-section.active { display: block; }
        
        #loader { position: fixed; inset: 0; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        
        /* Optimized Logo Styles */
        .app-logo-svg { width: 100%; height: 100%; object-fit: contain; }
        .cls-1 { fill: #f9f3f8; stroke-width: 0px; }
        .cls-2 { fill: #2d9ed8; stroke-width: 0px; }
    </style>
</head>

<body onload="brython()" class="h-screen overflow-hidden flex flex-col bg-base-200 text-base-content transition-colors duration-300">

    <!-- Loading -->
    <div id="loader" class="bg-neutral text-neutral-content">
        <span class="loading loading-spinner loading-lg text-sky-500 mb-4"></span>
        <h2 class="text-lg font-bold">Initializing Printos...</h2>
        <div id="loader-error" class="mt-4"></div>
    </div>

    <!-- Sidebar & Content Wrapper -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 hidden md:flex flex-col relative z-20 bg-base-100 border-r border-base-300 overflow-y-auto">
            <div class="p-6 sticky top-0 bg-base-100 z-10">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 flex-shrink-0">
                        <!-- Tightly bounded viewBox for maximum scaling -->
                        <svg class="app-logo-svg drop-shadow-md" viewBox="200 250 180 230" xmlns="http://www.w3.org/2000/svg">
                            <path class="cls-2" d="M355.17,356.98c0,33.76-27.37,61.13-61.13,61.13-7.42,0-14.54-1.32-21.12-3.75v-57.38c0-11.65,9.47-21.13,21.12-21.13s21.13,9.48,21.13,21.13-9.48,21.13-21.13,21.13c-4.53,0-8.73-1.43-12.17-3.88v22.04c3.85,1.2,7.93,1.84,12.17,1.84,22.68,0,41.13-18.45,41.13-41.13s-18.45-41.13-41.13-41.13-41.12,18.45-41.12,41.13v45.23c-12.29-11.18-20.01-27.3-20.01-45.23,0-33.76,27.37-61.13,61.13-61.13s61.13,27.37,61.13,61.13Z"/>
                            <path class="cls-1" d="M335.17,356.98c0,22.68-18.45,41.13-41.13,41.13-4.24,0-8.32-.64-12.17-1.84v-22.04c3.44,2.45,7.64,3.88,12.17,3.88,11.65,0,21.13-9.48,21.13-21.13s-9.48-21.13-21.13-21.13-21.12,9.48-21.12,21.13v57.38c-7.46-2.74-14.23-6.9-20-12.15v-45.23c0-22.68,18.44-41.13,41.12-41.13s41.13,18.45,41.13,41.13Z"/>
                            <polyline class="cls-2" points="272.92 414.36 272.92 446.45 252.92 446.45 252.92 402.21"/>
                        </svg>
                    </div> 
                    <h1 class="font-bold text-xl tracking-tight">Printos</h1>
                </div>
            </div>
            
            <ul class="menu flex-1 px-4 pb-6 gap-1">
                <li class="menu-title text-xs uppercase tracking-wider opacity-50" id="cat-main">Main</li>
                <li><a id="nav-dashboard" class="active"><i class="fa-solid fa-chart-pie w-4 text-center"></i> Dashboard</a></li>

                <li class="menu-title text-xs uppercase tracking-wider opacity-50 mt-2" id="cat-sales">Sales Module</li>
                <li><a id="nav-create"><i class="fa-solid fa-file-invoice-dollar w-4 text-center"></i> Create Invoice</a></li>
                <li><a id="nav-ledger"><i class="fa-solid fa-book w-4 text-center"></i> Ledger</a></li>
                <li><a id="nav-receivables"><i class="fa-solid fa-hand-holding-dollar w-4 text-center"></i> Receivables</a></li>
                <li><a id="nav-leads"><i class="fa-solid fa-users w-4 text-center"></i> Leads (CRM)</a></li>

                <li class="menu-title text-xs uppercase tracking-wider opacity-50 mt-2" id="cat-purch">Purchase Module</li>
                <li><a id="nav-purchase"><i class="fa-solid fa-cart-shopping w-4 text-center"></i> Purchase Entry</a></li>
                <li><a id="nav-payables"><i class="fa-solid fa-file-invoice w-4 text-center"></i> Payables</a></li>

                <li class="menu-title text-xs uppercase tracking-wider opacity-50 mt-2" id="cat-inv">Inventory & Accounts</li>
                <li><a id="nav-inventory"><i class="fa-solid fa-boxes-stacked w-4 text-center"></i> Stock & Inventory</a></li>
                <li><a id="nav-accounting"><i class="fa-solid fa-book-open w-4 text-center"></i> Accounting</a></li>
                <li><a id="nav-gst"><i class="fa-solid fa-scale-balanced w-4 text-center"></i> GST Compliance</a></li>

                <li class="menu-title text-xs uppercase tracking-wider opacity-50 mt-2" id="cat-util">Utilities</li>
                <li><a id="nav-utils"><i class="fa-solid fa-sliders w-4 text-center"></i> Tools & Backup</a></li>
            </ul>
            
            <div class="p-4 border-t border-base-300">
                <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-base-200 transition">
                    <div class="avatar placeholder">
                        <div class="w-8 rounded-full bg-neutral text-neutral-content">
                            <span class="text-xs" id="display-avatar">AD</span>
                        </div>
                    </div>
                    <div class="flex-1 text-sm text-base-content overflow-hidden">
                        <p class="font-bold truncate" id="display-user">Admin</p>
                        <p class="text-xs opacity-70 truncate" id="display-role">System Admin</p>
                    </div>
                    <button id="btn-logout-sidebar" class="btn btn-ghost btn-xs text-error"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden relative bg-base-200">
            
            <!-- Header (Topbar) -->
            <header class="navbar bg-base-100 border-b border-base-300 px-8 h-16 shrink-0">
                <div class="flex-1">
                    <h2 class="font-bold text-lg" id="page-title">Dashboard</h2>
                </div>
                <div class="flex-none gap-2">
                    <div id="header-alert" class="badge badge-error gap-2 hidden">
                        <i class="fa-solid fa-triangle-exclamation"></i> Low Stock
                    </div>
                    
                    <!-- Theme Toggle -->
                    <label class="swap swap-rotate btn btn-ghost btn-circle">
                        <input type="checkbox" id="theme-toggle-checkbox" />
                        <i class="swap-on fill-current fa-solid fa-sun text-lg text-sky-500"></i>
                        <i class="swap-off fill-current fa-solid fa-moon text-lg text-slate-500"></i>
                    </label>

                    <!-- Notifications Dropdown -->
                    <div class="dropdown dropdown-end">
                        <div tabindex="0" role="button" class="btn btn-ghost btn-circle">
                            <div class="indicator">
                                <i class="fa-regular fa-bell text-lg"></i>
                                <span id="notif-badge" class="badge badge-xs badge-error indicator-item hidden"></span>
                            </div>
                        </div>
                        <ul tabindex="0" id="notif-list" class="dropdown-content z-[60] menu p-4 shadow-2xl bg-base-100 rounded-box w-72 text-sm border border-base-300">
                            <li id="notif-title" class="menu-title px-0 pb-2">Notifications</li>
                            <li id="notif-empty"><a class="text-base-content/50 italic">No new notifications</a></li>
                        </ul>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-8 relative scroll-smooth">
                
                <!-- A. DASHBOARD -->
                <div id="view-dashboard" class="view-section active">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                            <div class="stats shadow w-full bg-base-100">
                                <div class="stat">
                                    <div class="stat-figure text-sky-500"><i class="fa-solid fa-wallet text-3xl"></i></div>
                                    <div class="stat-title text-base-content/70">Total Sales</div>
                                    <div class="stat-value text-sky-500">₹<span id="dash-sales">0.00</span></div>
                                </div>
                                <div class="stat">
                                    <div class="stat-figure text-violet-500"><i class="fa-solid fa-cart-shopping text-3xl"></i></div>
                                    <div class="stat-title text-base-content/70">Total Purchase</div>
                                    <div class="stat-value text-violet-500">₹<span id="dash-purchase">0.00</span></div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="stats shadow w-full bg-base-100">
                                    <div class="stat">
                                        <div class="stat-title text-base-content/70">Receivables</div>
                                        <div class="stat-value text-warning text-2xl">₹<span id="dash-receivable">0.00</span></div>
                                    </div>
                                </div>
                                <div class="stats shadow w-full bg-base-100">
                                    <div class="stat">
                                        <div class="stat-title text-base-content/70">Payables</div>
                                        <div class="stat-value text-error text-2xl">₹<span id="dash-payable">0.00</span></div>
                                    </div>
                                </div>
                            </div>

                            <div class="card bg-base-100 shadow-xl">
                                <div class="card-body">
                                    <h2 class="card-title text-base-content">Financial Overview</h2>
                                    <div class="h-64"><canvas id="mainChart"></canvas></div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div class="card bg-base-100 shadow-xl">
                                <div class="card-body">
                                    <h2 class="card-title text-warning text-base"><i class="fa-solid fa-triangle-exclamation"></i> Low Stock Alerts</h2>
                                    <ul id="low-stock-list" class="menu bg-base-200 w-full rounded-box p-2 text-xs">
                                        <li><a class="text-base-content">All stocks are healthy.</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card bg-base-100 shadow-xl">
                                <div class="card-body">
                                    <h2 class="card-title text-base text-base-content">Cash Flow</h2>
                                    <div class="h-48"><canvas id="pieChart"></canvas></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- B. SALES MODULE -->
                <div id="view-create" class="view-section">
                    <div class="card bg-base-100 shadow-xl max-w-4xl mx-auto">
                        <div class="card-body">
                            <div class="flex justify-between items-center border-b border-base-300 pb-4 mb-4">
                                <h2 class="card-title text-base-content font-bold">Sales / Outward</h2>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-bold opacity-50 uppercase">Ref No:</span>
                                    <input type="text" id="next-inv" class="input input-xs input-bordered w-32 text-center font-bold text-sky-500" value="#DOC-001">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-4 mb-4">
                                <div class="form-control w-full">
                                    <label class="label"><span class="label-text font-bold">Doc Type</span></label>
                                    <select id="sales-type" class="select select-bordered w-full text-base-content">
                                        <option value="Invoice">Tax Invoice</option>
                                        <option value="Quotation">Quotation</option>
                                        <option value="Proforma">Proforma Invoice</option>
                                        <option value="Credit Note">Credit Note</option>
                                    </select>
                                </div>
                                <div class="form-control w-full">
                                    <label class="label"><span class="label-text font-bold">Date</span></label>
                                    <input type="date" id="sales-date" class="input input-bordered w-full text-base-content">
                                </div>
                                <div class="form-control w-full">
                                    <label class="label"><span class="label-text font-bold">Barcode</span></label>
                                    <input type="text" id="sales-barcode" class="input input-bordered w-full text-base-content" placeholder="Scan...">
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="form-control w-full">
                                    <label class="label"><span class="label-text font-bold" id="lbl-customer">Customer Name</span></label>
                                    <input type="text" id="sales-cust" list="customer-list" class="input input-bordered w-full text-base-content" placeholder="Select or Type...">
                                    <datalist id="customer-list"></datalist>
                                </div>
                                <div class="form-control w-full">
                                    <label class="label"><span class="label-text font-bold">Item Description</span></label>
                                    <input type="text" id="sales-item" class="input input-bordered w-full text-base-content" placeholder="Product / Service">
                                </div>
                            </div>

                            <div class="grid grid-cols-4 gap-4 mb-6">
                                <div class="form-control w-full">
                                    <label class="label"><span class="label-text font-bold">Qty</span></label>
                                    <input type="number" id="sales-qty" class="input input-bordered w-full text-base-content" value="1">
                                </div>
                                <div class="form-control w-full" id="field-price">
                                    <label class="label"><span class="label-text font-bold">Price</span></label>
                                    <input type="number" id="sales-price" class="input input-bordered w-full text-base-content" placeholder="0.00">
                                </div>
                                <div class="form-control w-full" id="field-gst">
                                    <label class="label"><span class="label-text font-bold">GST %</span></label>
                                    <select id="sales-gst" class="select select-bordered w-full text-base-content">
                                        <option value="18">18%</option>
                                        <option value="12">12%</option>
                                        <option value="5">5%</option>
                                        <option value="0">0%</option>
                                    </select>
                                </div>
                                <div class="form-control w-full" id="field-status">
                                    <label class="label"><span class="label-text font-bold">Payment</span></label>
                                    <select id="sales-status" class="select select-bordered w-full text-base-content">
                                        <option value="Unpaid">Unpaid</option>
                                        <option value="Paid">Paid</option>
                                    </select>
                                </div>
                            </div>

                            <button id="btn-save-sales" class="btn bg-sky-500 hover:bg-sky-600 text-white border-none w-full shadow-lg shadow-sky-500/30">Generate Document</button>
                            <p id="status-msg" class="text-center text-sm font-bold mt-2 h-4"></p>
                        </div>
                    </div>
                </div>

                <!-- C. PURCHASE MODULE -->
                <div id="view-purchase" class="view-section">
                    <div class="card bg-base-100 shadow-xl max-w-4xl mx-auto border-l-4 border-violet-500">
                        <div class="card-body">
                            <h2 class="card-title text-base-content font-bold">Purchase Entry</h2>
                            <div class="grid grid-cols-2 gap-4">
                                <input type="text" id="purch-vendor" placeholder="Supplier" class="input input-bordered w-full text-base-content" />
                                <input type="text" id="purch-item" placeholder="Item" class="input input-bordered w-full text-base-content" />
                                <input type="number" id="purch-qty" placeholder="Qty" class="input input-bordered w-full text-base-content" value="1" />
                                <input type="number" id="purch-cost" placeholder="Cost" class="input input-bordered w-full text-base-content" />
                                <select id="purch-type" class="select select-bordered text-base-content"><option value="Purchase">Purchase</option></select>
                                <select id="purch-cat" class="select select-bordered text-base-content"><option value="General">General</option></select>
                                <select id="purch-status" class="select select-bordered text-base-content"><option value="Paid">Paid</option><option value="Unpaid">Unpaid</option></select>
                            </div>
                            <button id="btn-save-purchase" class="btn bg-violet-500 hover:bg-violet-600 border-none mt-4 text-white shadow-lg shadow-violet-500/30">Record Purchase</button>
                        </div>
                    </div>
                </div>

                <div id="view-inventory" class="view-section">
                    <div class="card bg-base-100 shadow-xl h-[700px]">
                        <div class="card-body p-0">
                            <div class="p-6 border-b border-base-300 flex justify-between items-center text-base-content">
                                <h3 class="card-title">Stock Summary</h3>
                                <button id="btn-export-csv" class="btn btn-sm btn-outline">Export CSV</button>
                            </div>
                            <div class="overflow-auto"><table class="table table-zebra w-full text-base-content"><thead class="sticky top-0 bg-base-100"><tr><th>Item</th><th>Category</th><th class="text-right">Qty</th><th class="text-right">Avg Cost</th><th class="text-right">Value</th><th class="text-center">Status</th></tr></thead><tbody id="inventory-body"></tbody></table></div>
                        </div>
                    </div>
                </div>

                <div id="view-accounting" class="view-section">
                    <div class="card bg-base-100 shadow-xl p-6">
                        <h2 class="card-title mb-4 text-base-content font-bold">Accounting Overview</h2>
                        <div class="stats bg-neutral text-neutral-content w-full">
                            <div class="stat">
                                <div class="stat-title text-neutral-content/70">Profit / Loss</div>
                                <div class="stat-value" id="pl-net">₹0.00</div>
                                <div class="stat-desc" id="pl-rev">Revenue: ₹0.00</div>
                                <div class="stat-desc" id="pl-exp">Expense: ₹0.00</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-ledger" class="view-section">
                    <div class="card bg-base-100 shadow-xl p-6 h-[700px] flex flex-col">
                        <div class="flex justify-between mb-4 text-base-content items-center">
                            <h2 class="card-title font-bold">Ledger</h2>
                            <div class="join"><input type="text" id="search-bar" class="input input-bordered join-item input-sm text-base-content" placeholder="Search..." /><button id="btn-clear" class="btn btn-sm join-item">Reset</button></div>
                        </div>
                        <div class="overflow-auto flex-1"><table class="table table-zebra w-full text-base-content"><thead class="sticky top-0 bg-base-100"><tr><th>Date</th><th>Party (Doc)</th><th class="text-right">Amount</th><th class="text-center">Status</th><th class="text-center">Action</th></tr></thead><tbody id="ledger-body"></tbody></table></div>
                    </div>
                </div>

                <div id="view-leads" class="view-section">
                    <div class="card bg-base-100 shadow-xl p-6 h-[700px] flex flex-col">
                        <div class="flex justify-between mb-4 text-base-content items-center">
                            <h2 class="card-title font-bold">Leads</h2>
                            <button id="btn-open-lead-panel" class="btn bg-sky-500 hover:bg-sky-600 text-white border-none btn-sm">Add Lead</button>
                        </div>
                        <div class="overflow-auto flex-1">
                            <table class="table table-zebra w-full text-base-content"><thead class="sticky top-0 bg-base-100"><tr><th>Name</th><th>Source</th><th>Status</th></tr></thead><tbody id="leads-body"></tbody></table>
                        </div>
                    </div>
                </div>

                <div id="view-receivables" class="view-section">
                    <div class="card bg-base-100 shadow-xl p-6 h-[700px] flex flex-col">
                        <h2 class="card-title mb-4 text-base-content font-bold">Receivables</h2>
                        <div class="overflow-auto flex-1">
                            <table class="table w-full text-base-content"><thead class="sticky top-0 bg-base-100"><tr><th>Date</th><th>Customer</th><th class="text-right">Amount</th></tr></thead><tbody id="receivables-body"></tbody></table>
                        </div>
                    </div>
                </div>

                <div id="view-payables" class="view-section">
                    <div class="card bg-base-100 shadow-xl p-6 h-[700px] flex flex-col">
                        <h2 class="card-title mb-4 text-base-content font-bold">Payables</h2>
                        <div class="overflow-auto flex-1">
                            <table class="table w-full text-base-content"><thead class="sticky top-0 bg-base-100"><tr><th>Date</th><th>Supplier</th><th class="text-right">Amount</th></tr></thead><tbody id="payables-body"></tbody></table>
                        </div>
                    </div>
                </div>

                <div id="view-utils" class="view-section">
                    <div class="grid grid-cols-3 gap-6 text-base-content">
                        <div class="card bg-base-100 shadow-xl p-6 text-center">
                            <div class="flex justify-center mb-2 text-sky-500 text-3xl"><i class="fa-solid fa-cloud-arrow-down"></i></div>
                            <button id="btn-backup" class="btn bg-sky-500 hover:bg-sky-600 text-white border-none btn-sm">Download Backup</button>
                        </div>
                        <div class="card bg-base-100 shadow-xl p-6 text-center">
                            <div class="flex justify-center mb-2 text-success text-3xl"><i class="fa-solid fa-cloud-arrow-up"></i></div>
                            <input type="file" id="upload-json" class="hidden" accept=".json,.vyb" />
                            <label for="upload-json" class="btn btn-success btn-sm text-white border-none w-full cursor-pointer">Restore Data</label>
                            <button id="btn-process-restore" class="hidden">Hidden Process</button>
                        </div>
                        <div class="card bg-base-100 shadow-xl p-6 text-center">
                            <div class="flex justify-center mb-2 text-violet-500 text-3xl"><i class="fa-solid fa-users"></i></div>
                            <button id="btn-user-roles" class="btn bg-violet-500 hover:bg-violet-600 text-white border-none btn-sm">Roles & Users</button>
                        </div>
                    </div>
                </div>

                <div id="view-gst" class="view-section">
                    <div class="card bg-base-100 shadow-xl p-6 text-base-content">
                        <h2 class="card-title mb-4 font-bold">GST Compliance</h2>
                        <div class="bg-base-200 p-6 rounded-lg font-mono text-sm leading-relaxed">
                            <div class="flex justify-between border-b border-base-300 pb-2 mb-2"><span>GSTR-1 Total Sales:</span> <span class="font-bold">₹0.00</span></div>
                            <div class="flex justify-between border-b border-base-300 pb-2 mb-2"><span>GSTR-2 Total Purchases:</span> <span class="font-bold">₹0.00</span></div>
                            <div class="flex justify-between text-success"><span>Estimated ITC:</span> <span class="font-bold">₹0.00</span></div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-[60] bg-base-200 flex items-center justify-center p-4 transition-all duration-500">
        <div class="card w-96 bg-base-100 shadow-xl">
            <div class="card-body items-center text-center">
                <div class="w-32 h-32 mb-2 flex items-center justify-center">
                    <svg class="app-logo-svg drop-shadow-xl" viewBox="200 250 180 230" xmlns="http://www.w3.org/2000/svg">
                        <path class="cls-2" d="M355.17,356.98c0,33.76-27.37,61.13-61.13,61.13-7.42,0-14.54-1.32-21.12-3.75v-57.38c0-11.65,9.47-21.13,21.12-21.13s21.13,9.48,21.13,21.13-9.48,21.13-21.13,21.13c-4.53,0-8.73-1.43-12.17-3.88v22.04c3.85,1.2,7.93,1.84,12.17,1.84,22.68,0,41.13-18.45,41.13-41.13s-18.45-41.13-41.13-41.13-41.12,18.45-41.12,41.13v45.23c-12.29-11.18-20.01-27.3-20.01-45.23,0-33.76,27.37-61.13,61.13-61.13s61.13,27.37,61.13,61.13Z"/>
                        <path class="cls-1" d="M335.17,356.98c0,22.68-18.45,41.13-41.13,41.13-4.24,0-8.32-.64-12.17-1.84v-22.04c3.44,2.45,7.64,3.88,12.17,3.88,11.65,0,21.13-9.48,21.13-21.13s-9.48-21.13-21.13-21.13-21.12,9.48-21.12,21.13v57.38c-7.46-2.74-14.23-6.9-20-12.15v-45.23c0-22.68,18.44-41.13,41.12-41.13s41.13,18.45,41.13,41.13Z"/>
                        <polyline class="cls-2" points="272.92 414.36 272.92 446.45 252.92 446.45 252.92 402.21"/>
                    </svg>
                </div>
                <h2 class="card-title text-2xl text-base-content font-bold">Login to Printos</h2>
                <div class="form-control w-full gap-2 mt-4">
                    <input type="text" id="login-user" placeholder="User ID" class="input input-bordered text-base-content" />
                    <input type="password" id="login-pass" placeholder="Password" class="input input-bordered text-base-content" />
                </div>
                <button id="btn-login" class="btn bg-sky-500 hover:bg-sky-600 text-white border-none w-full mt-4">Secure Login</button>
                <p id="login-msg" class="text-error text-sm mt-2 font-bold"></p>
                <div class="text-xs opacity-50 mt-4">Admin: admin / admin<br>Staff: User / User</div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <dialog id="invoice_modal" class="modal">
        <div class="modal-box w-11/12 max-w-3xl bg-base-100 text-base-content rounded-3xl">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-4 top-4">✕</button>
            </form>
            <h3 class="font-bold text-xl mb-6">Document Preview</h3>
            <div id="printable-area" class="p-8 border border-base-300 rounded-2xl bg-base-100">
                <div class="flex justify-between mb-8 border-b border-base-300 pb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-16 h-16 flex items-center justify-center">
                            <svg class="app-logo-svg" viewBox="200 250 180 230" xmlns="http://www.w3.org/2000/svg">
                                <path class="cls-2" d="M355.17,356.98c0,33.76-27.37,61.13-61.13,61.13-7.42,0-14.54-1.32-21.12-3.75v-57.38c0-11.65,9.47-21.13,21.12-21.13s21.13,9.48,21.13,21.13-9.48,21.13-21.13,21.13c-4.53,0-8.73-1.43-12.17-3.88v22.04c3.85,1.2,7.93,1.84,12.17,1.84,22.68,0,41.13-18.45,41.13-41.13s-18.45-41.13-41.13-41.13-41.12,18.45-41.12,41.13v45.23c-12.29-11.18-20.01-27.3-20.01-45.23,0-33.76,27.37-61.13,61.13-61.13s61.13,27.37,61.13,61.13Z"/>
                                <path class="cls-1" d="M335.17,356.98c0,22.68-18.45,41.13-41.13,41.13-4.24,0-8.32-.64-12.17-1.84v-22.04c3.44,2.45,7.64,3.88,12.17,3.88,11.65,0,21.13-9.48,21.13-21.13s-9.48-21.13-21.13-21.13-21.12,9.48-21.12,21.13v57.38c-7.46-2.74-14.23-6.9-20-12.15v-45.23c0-22.68,18.44-41.13,41.12-41.13s41.13,18.45,41.13,41.13Z"/>
                                <polyline class="cls-2" points="272.92 414.36 272.92 446.45 252.92 446.45 252.92 402.21"/>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold text-sky-500 mb-1">Printos</h1>
                            <p class="text-xs opacity-60 uppercase font-bold tracking-widest">Digital Solutions</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <h2 class="text-2xl font-bold uppercase tracking-tight" id="doc-title">INVOICE</h2>
                        <p id="inv-num" class="font-mono text-sm font-bold opacity-70">--</p>
                        <p id="inv-date" class="text-xs opacity-50 mt-1">--</p>
                    </div>
                </div>
                <div class="mb-8">
                    <p class="text-xs font-bold opacity-40 uppercase mb-1">Billed To</p>
                    <h3 class="text-2xl font-bold" id="inv-customer">Customer</h3>
                    <p id="inv-project" class="text-sm opacity-60 mt-1">Project: --</p>
                </div>
                <table class="table table-sm w-full mb-6">
                    <thead class="bg-base-200">
                        <tr>
                            <th>Description</th>
                            <th class="text-right">Qty</th>
                            <th class="text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody id="inv-items"></tbody>
                </table>
                <div class="flex justify-end pt-4 border-t border-base-200">
                    <div class="text-right">
                        <p class="text-sm opacity-60">Amount Due</p>
                        <h2 class="text-3xl font-bold text-sky-500">₹<span id="inv-total">0.00</span></h2>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button id="btn-print-sys" class="btn bg-sky-500 hover:bg-sky-600 text-white border-none px-8 rounded-xl font-bold shadow-lg shadow-sky-500/20">Print PDF</button>
            </div>
        </div>
    </dialog>

    <dialog id="warning_modal" class="modal">
        <div class="modal-box text-center bg-base-100 text-base-content rounded-3xl border border-warning/20 shadow-2xl">
            <div class="flex justify-center mb-4 text-warning text-6xl"><i class="fa-solid fa-triangle-exclamation"></i></div>
            <h3 class="font-bold text-xl">Credit Limit Warning</h3>
            <p class="py-4 text-slate-500" id="warning-msg"></p>
            <div class="modal-action justify-center">
                <form method="dialog">
                    <button class="btn btn-neutral rounded-xl px-10">I Understand</button>
                </form>
            </div>
        </div>
    </dialog>
    
    <dialog id="success_modal" class="modal">
        <div class="modal-box text-center bg-base-100 text-base-content rounded-3xl border border-success/20 shadow-2xl">
            <div class="flex justify-center mb-4 text-success text-6xl"><i class="fa-solid fa-circle-check"></i></div>
            <h3 class="font-bold text-xl" id="success-msg">Success!</h3>
            <div class="modal-action justify-center">
                <form method="dialog">
                    <button class="btn bg-sky-500 hover:bg-sky-600 border-none text-white rounded-xl px-10 font-bold shadow-lg shadow-sky-500/20">Awesome</button>
                </form>
            </div>
        </div>
    </dialog>

    <!-- ROLES MANAGEMENT MODAL -->
    <dialog id="roles_modal" class="modal">
        <div class="modal-box bg-base-100 text-base-content rounded-3xl">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-4 top-4">✕</button>
            </form>
            <h3 class="font-bold text-xl mb-4">Manage Users</h3>
            
            <div class="overflow-auto mb-6 max-h-48 border border-base-300 rounded-lg">
                <table class="table table-sm w-full">
                    <thead class="bg-base-200"><tr><th>User ID</th><th>Role</th></tr></thead>
                    <tbody id="users-list-body"></tbody>
                </table>
            </div>
            
            <h4 class="font-bold mb-2">Add New User</h4>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <input type="text" id="new-user-id" placeholder="User ID" class="input input-bordered w-full" />
                <input type="password" id="new-user-pass" placeholder="Password" class="input input-bordered w-full" />
                <select id="new-user-role" class="select select-bordered w-full col-span-2">
                    <option value="User">User (Data Entry Only)</option>
                    <option value="Manager">Manager (View + Entry)</option>
                    <option value="Admin">Admin (Full Access)</option>
                </select>
            </div>
            <button id="btn-save-user" class="btn bg-violet-500 hover:bg-violet-600 border-none text-white w-full font-bold shadow-lg shadow-violet-500/20">Create User</button>
        </div>
    </dialog>

    <!-- Slide Over Lead -->
    <div id="slide-over-panel" class="fixed top-0 right-0 h-full w-96 bg-base-100 shadow-2xl z-50 p-8 border-l border-base-300 closed flex flex-col transition-all duration-300 overflow-y-auto">
        <div class="flex justify-between items-center mb-8 text-base-content shrink-0">
            <h3 class="font-bold text-xl">Add Lead</h3>
            <button id="close-slide-over" class="btn btn-sm btn-circle btn-ghost">✕</button>
        </div>
        <div class="form-control gap-4 flex-1 text-base-content">
            <div class="space-y-1">
                <label class="text-xs font-bold opacity-50 uppercase pl-1 tracking-wider">Client Name <span class="text-error">*</span></label>
                <input type="text" id="quick-lead-name" placeholder="Contact Name" class="input input-bordered w-full" />
            </div>
            <div class="space-y-1">
                <label class="text-xs font-bold opacity-50 uppercase pl-1 tracking-wider">Lead Source</label>
                <select id="quick-lead-source" class="select select-bordered w-full">
                    <option>LinkedIn</option>
                    <option>Referral</option>
                    <option>Website</option>
                    <option>Social Media</option>
                    <option>Others</option>
                </select>
            </div>
            <div class="space-y-1">
                <label class="text-xs font-bold opacity-50 uppercase pl-1 tracking-wider">Mobile Number</label>
                <div class="join w-full">
                    <select id="quick-lead-cc" class="select select-bordered join-item w-1/3">
                        <option>+91</option>
                        <option>+971</option>
                        <option>+1</option>
                        <option>+44</option>
                        <option>+966</option>
                    </select>
                    <input type="text" id="quick-lead-mobile" placeholder="Numbers only" class="input input-bordered join-item w-2/3" oninput="this.value = this.value.replace(/[^0-9]/g, '')" />
                </div>
            </div>
            <div class="space-y-1">
                <label class="text-xs font-bold opacity-50 uppercase pl-1 tracking-wider">Email ID</label>
                <input type="email" id="quick-lead-email" placeholder="mail@example.com" class="input input-bordered w-full" />
            </div>
            <p class="text-[10px] text-info italic mt-1 pl-1">Provide either Mobile or Email to enable save.</p>
            <div class="space-y-1 mt-4">
                <label class="text-xs font-bold opacity-50 uppercase pl-1 tracking-wider">Comments <span class="text-error">*</span></label>
                <textarea id="quick-lead-comments" class="textarea textarea-bordered w-full h-24 text-sm" placeholder="Enter comments here... (Min 10 words)"></textarea>
                <div class="text-right mt-1"><span id="word-count-msg" class="text-xs font-bold text-error">0/10 words</span></div>
            </div>
        </div>
        <button id="btn-save-quick-lead" class="btn w-full mt-6 text-white font-bold rounded-xl shadow-lg bg-slate-300 cursor-not-allowed border-none shrink-0 transition-all duration-300" disabled>Save Lead</button>
    </div>

    <!-- FAB -->
    <div class="fab-container">
        <ul class="fab-menu menu bg-base-100 w-48 rounded-box shadow-2xl border border-base-200">
            <li><a id="fab-purchase" class="text-violet-500 font-bold hover:bg-violet-500/10"><i class="fa-solid fa-cart-shopping"></i> Purchase</a></li>
            <li><a id="fab-sales" class="text-sky-500 font-bold hover:bg-sky-500/10"><i class="fa-solid fa-file-invoice"></i> Invoice</a></li>
            <li><a id="fab-lead" class="text-accent font-bold hover:bg-accent/10"><i class="fa-solid fa-user-plus"></i> Lead</a></li>
        </ul>
        <button id="fab-main-btn" class="btn btn-circle bg-sky-500 hover:bg-sky-600 border-none btn-lg shadow-2xl text-white">
            <i class="fa-solid fa-plus text-2xl"></i>
        </button>
    </div>

    <!-- Python Engine -->
    <script type="text/python">
        from browser import document, window, html, aio
        import datetime
        import json

        # --- DATA STRUCTURES ---
        ledger = []
        inventory = {"Paper Rim": {"qty": 150, "cost": 220.0, "category": "Raw Material"}}
        leads = []
        company_db = set()
        chart_main = None
        
        # RBAC System
        users = {
            "admin": {"password": "admin", "role": "Admin"},
            "User": {"password": "User", "role": "User"}
        }
        current_user = None
        current_role = None

        class Transaction:
            def __init__(self, t_type, doc_type, ref_no, party, item, qty, price, gst, status):
                self.id = len(ledger) + 1
                self.ref_no = ref_no
                self.date = datetime.datetime.now().strftime("%Y-%m-%d")
                self.type = t_type
                self.doc_type = doc_type
                self.party = party
                self.item = item
                self.qty = int(qty)
                self.price = float(price)
                self.gst_percent = int(gst)
                self.status = status
                self.base_amt = self.qty * self.price
                self.tax_amt = (self.base_amt * self.gst_percent) / 100
                self.total = self.base_amt + self.tax_amt
            def to_dict(self): return self.__dict__

        # --- RBAC / AUTH HANDLERS ---
        def apply_permissions():
            navs = ["nav-dashboard", "nav-create", "nav-ledger", "nav-receivables", "nav-leads", "nav-purchase", "nav-payables", "nav-inventory", "nav-accounting", "nav-gst", "nav-utils"]
            cats = ["cat-main", "cat-sales", "cat-purch", "cat-inv", "cat-util"]
            
            for nav in navs:
                if document.getElementById(nav): document[nav].style.display = ""
            for cat in cats:
                if document.getElementById(cat): document[cat].style.display = ""
                
            document["btn-user-roles"].style.display = ""
            
            if current_role == "User":
                restricted = ["nav-dashboard", "nav-ledger", "nav-receivables", "nav-payables", "nav-inventory", "nav-accounting", "nav-gst", "nav-utils"]
                rcats = ["cat-main", "cat-inv", "cat-util"]
                for nav in restricted:
                    if document.getElementById(nav): document[nav].style.display = "none"
                for cat in rcats:
                    if document.getElementById(cat): document[cat].style.display = "none"
                switch_view("view-create")
            elif current_role == "Manager":
                document["btn-user-roles"].style.display = "none"
                switch_view("view-dashboard")
            else:
                switch_view("view-dashboard")
                
            document["display-user"].text = current_user
            document["display-role"].text = current_role
            document["display-avatar"].text = current_user[:2].upper()

        def login_handler(evt):
            global current_user, current_role
            u = document["login-user"].value
            p = document["login-pass"].value
            
            if u in users and users[u]["password"] == p:
                current_user = u
                current_role = users[u]["role"]
                document["login-screen"].classList.add("fade-out")
                window.setTimeout(lambda: document["login-screen"].style.setProperty("display", "none"), 500)
                apply_permissions()
                document["login-msg"].text = ""
            else:
                document["login-msg"].text = "Invalid User ID or Password"

        def logout_handler(evt):
            today = datetime.date.today()
            hot = sum(1 for l in leads if (today - datetime.datetime.strptime(l.get("date", "2020-01-01"), "%Y-%m-%d").date()).days >= 15)
            if hot > 0:
                window.alert(f"SECURITY ALERT: You cannot logout. You must resolve {hot} HOT leads first!")
                switch_view("view-leads")
            else:
                document["login-screen"].style.removeProperty("display")
                document["login-screen"].classList.remove("fade-out")
                document["login-user"].value = ""
                document["login-pass"].value = ""
                
        def open_roles_modal(evt):
            if current_role != "Admin":
                window.alert("Access Denied.")
                return
            render_users_list()
            document["roles_modal"].showModal()
            
        def render_users_list():
            tbody = document["users-list-body"]
            tbody.clear()
            for u, data in users.items():
                row = html.TR()
                row <= html.TD(u, Class="font-bold")
                row <= html.TD(html.SPAN(data["role"], Class="badge badge-ghost badge-sm"))
                tbody <= row
                
        def save_new_user(evt):
            uid, pwd, role = document["new-user-id"].value.strip(), document["new-user-pass"].value, document["new-user-role"].value
            if not uid or not pwd: return
            users[uid] = {"password": pwd, "role": role}
            render_users_list()
            document["new-user-id"].value = ""
            document["new-user-pass"].value = ""
            document["success_modal"].showModal()

        # --- CORE FORM LOGIC ---
        def save_sales(evt):
            try:
                ref_no = document["next-inv"].value
                dtype, cust, item, qty, price, gst, status = [document[i].value for i in ["sales-type", "sales-cust", "sales-item", "sales-qty", "sales-price", "sales-gst", "sales-status"]]
                if not item or not price: return window.alert("Fill required fields (Item & Price)")
                tx = Transaction("Sale", dtype, ref_no, cust, item, qty, price, gst, status)
                ledger.append(tx)
                if cust: company_db.add(cust)
                refresh_all()
                document["status-msg"].text = "Transaction saved successfully!"
                document["status-msg"].class_name = "text-center text-sm font-bold mt-2 h-4 text-success"
                document["sales-item"].value = ""; document["sales-price"].value = ""
                check_credit_limit(cust)
                window.setTimeout(lambda: document["status-msg"].setAttribute("text", ""), 3000)
            except Exception as e: window.alert(f"Error: {e}")

        def save_purchase(evt):
            try:
                vendor, item, qty, cost, status = [document[i].value for i in ["purch-vendor", "purch-item", "purch-qty", "purch-cost", "purch-status"]]
                tx = Transaction("Purchase", "Bill", f"PUR-{len(ledger)+1:03}", vendor, item, qty, cost, 0, status)
                ledger.append(tx)
                refresh_all()
                window.alert("Purchase recorded!")
            except Exception as e: window.alert(f"Error: {e}")

        def toggle_theme(evt):
            h = document.select("html")[0]
            t = "dark" if h.getAttribute("data-theme") == "light" else "light"
            h.setAttribute("data-theme", t)

        def switch_view(view_id):
            for el in document.select(".view-section"): el.classList.remove("active")
            for btn in document.select("#sidebar .menu li a"): btn.classList.remove("active")
            if document.getElementById(view_id): document[view_id].classList.add("active")
            nav_id = view_id.replace("view-", "nav-")
            if document.getElementById(nav_id): document[nav_id].classList.add("active")
            document["page-title"].text = view_id.replace("view-", "").capitalize()

        def refresh_all():
            render_ledger(); render_inventory(); render_leads(); render_receivables(); render_payables(); update_dash(); update_customer_suggestions()

        def update_dash():
            s = sum(t.total for t in ledger if t.type == "Sale")
            p = sum(t.total for t in ledger if t.type == "Purchase")
            rec = sum(t.total for t in ledger if t.type == "Sale" and t.status == "Unpaid")
            pay = sum(t.total for t in ledger if t.type == "Purchase" and t.status == "Unpaid")
            document["dash-sales"].text = f"{s:,.2f}"; document["dash-purchase"].text = f"{p:,.2f}"
            document["dash-receivable"].text = f"{rec:,.2f}"; document["dash-payable"].text = f"{pay:,.2f}"; document["pl-net"].text = f"₹{s-p:,.2f}"
            document["next-inv"].value = f"#DOC-{len(ledger)+1:03}"
            
            # Notifications
            nl, empty, badge = document["notif-list"], document["notif-empty"], document["notif-badge"]
            for c in list(nl.children): 
                if c.id not in ["notif-title", "notif-empty"]: nl.removeChild(c)
            alerts = sum(1 for _, d in inventory.items() if d["qty"] < 5)
            if alerts:
                badge.classList.remove("hidden"); empty.style.display="none"
                document["header-alert"].classList.remove("hidden")
                for n, d in inventory.items():
                    if d["qty"] < 5:
                        li = html.LI(); li <= html.A(f"Low Stock: {n}", Class="text-error"); nl <= li
            else:
                badge.classList.add("hidden"); empty.style.display="block"; document["header-alert"].classList.add("hidden")

            if chart_main:
                chart_main.data.datasets[0].data = [s]; chart_main.data.datasets[1].data = [p]; chart_main.update()

        def render_ledger():
            tbody = document["ledger-body"]; tbody.clear()
            for t in reversed(ledger):
                row = html.TR(Class="hover")
                row <= html.TD(t.date, Class="text-xs opacity-70")
                det = html.DIV(); det <= html.DIV(t.party, Class="font-bold"); det <= html.DIV(f"{t.doc_type} | {t.ref_no}", Class="text-xs opacity-50")
                row <= html.TD(det); row <= html.TD(f"₹{t.total:.2f}", Class="text-right font-bold")
                
                status_class = "badge-success" if t.status == "Paid" else "badge-warning"
                row <= html.TD(html.SPAN(t.status, Class=f"badge {status_class} badge-sm"), Class="text-center")
                
                btn = html.BUTTON(Class="btn btn-ghost btn-xs text-sky-500", id=f"p-{t.id}"); btn.bind("click", show_preview); btn <= html.I(Class="fa-solid fa-eye")
                row <= html.TD(btn, Class="text-center"); tbody <= row

        def render_inventory():
            tbody = document["inventory-body"]; tbody.clear()
            for n, d in inventory.items():
                row = html.TR(Class="hover")
                row <= html.TD(n, Class="font-bold"); row <= html.TD(d["category"]); row <= html.TD(str(d["qty"]), Class="text-right font-mono")
                row <= html.TD(f"{d['cost']:.2f}"); row <= html.TD(f"{d['qty']*d['cost']:.2f}", Class="text-right font-bold"); row <= html.TD(html.SPAN("In Stock", Class="badge badge-success badge-sm"), Class="text-center"); tbody <= row

        def render_leads():
            tbody = document["leads-body"]; tbody.clear()
            if not leads: return (tbody <= html.TR(html.TD("No active leads", colspan="3", Class="text-center py-10 opacity-30")))
            for l in leads:
                row = html.TR(Class="hover"); row <= html.TD(l["name"], Class="font-bold"); row <= html.TD(l["source"], Class="opacity-70"); row <= html.TD(html.SPAN("NEW", Class="badge badge-info badge-sm")); tbody <= row

        def render_receivables():
            tbody = document["receivables-body"]; tbody.clear()
            unpaid = [x for x in ledger if x.type=="Sale" and x.status=="Unpaid"]
            if not unpaid: tbody <= html.TR(html.TD("Clean", colspan="3", Class="text-center opacity-30"))
            for t in unpaid:
                row = html.TR(); row <= html.TD(t.date); row <= html.TD(t.party); row <= html.TD(f"₹{t.total:.2f}", Class="text-right font-bold text-warning"); tbody <= row

        def render_payables():
            tbody = document["payables-body"]; tbody.clear()
            unpaid = [x for x in ledger if x.type=="Purchase" and x.status=="Unpaid"]
            if not unpaid: tbody <= html.TR(html.TD("Clean", colspan="3", Class="text-center opacity-30"))
            for t in unpaid:
                row = html.TR(); row <= html.TD(t.date); row <= html.TD(t.party); row <= html.TD(f"₹{t.total:.2f}", Class="text-right font-bold text-error"); tbody <= row

        def check_credit_limit(c):
            if not c: return
            out = sum(t.total for t in ledger if t.party.lower() == c.lower() and t.status == "Unpaid")
            if out > 5000: document["warning-msg"].text = f"{c} balance: ₹{out:,.2f}."; document["warning_modal"].showModal()

        def update_customer_suggestions():
            dl = document["customer-list"]; dl.clear()
            for c in sorted(list(company_db)): dl <= html.OPTION(value=c)

        def show_preview(evt):
            try:
                idx = int(evt.target.closest("button").id.split("-")[1])
                t = next(x for x in ledger if x.id == idx)
                document["doc-title"].text = t.doc_type; document["inv-total"].text = f"{t.total:.2f}"; document["inv-num"].text = t.ref_no; document["inv-customer"].text = t.party; document["inv-date"].text = t.date
                tbody = document["inv-items"]; tbody.clear(); row = html.TR(); row <= html.TD(t.item); row <= html.TD(str(t.qty), Class="text-right"); row <= html.TD(f"₹{t.total:.2f}", Class="text-right"); tbody <= row
                document["invoice_modal"].showModal()
            except: pass
            
        def validate_lead_form(evt):
            n, m, e, c = [document[i].value.strip() for i in ["quick-lead-name", "quick-lead-mobile", "quick-lead-email", "quick-lead-comments"]]
            words = len([w for w in c.split() if w])
            document["word-count-msg"].text = f"{words}/10 words"
            document["word-count-msg"].class_name = "text-xs font-bold " + ("text-success" if words >= 10 else "text-error")
            btn = document["btn-save-quick-lead"]
            if n and words >= 10 and (m or e):
                btn.disabled = False; btn.class_name = "btn w-full mt-6 text-white font-bold rounded-xl shadow-lg bg-sky-500 hover:bg-sky-600 border-none shrink-0"
            else:
                btn.disabled = True; btn.class_name = "btn w-full mt-6 text-white font-bold rounded-xl shadow-lg bg-slate-300 cursor-not-allowed border-none shrink-0"

        def save_quick_lead(evt):
            n, s, cc, m, e, c = [document[i].value.strip() for i in ["quick-lead-name", "quick-lead-source", "quick-lead-cc", "quick-lead-mobile", "quick-lead-email", "quick-lead-comments"]]
            full_mob = cc + m if m else ""
            if any(l["name"].lower() == n.lower() for l in leads): return window.alert("Lead exists!")
            leads.append({"name": n, "source": s, "mobile": full_mob, "email": e, "comments": c, "date": datetime.date.today().strftime("%Y-%m-%d"), "status": "New"})
            for i in ["name", "mobile", "email", "comments"]: document[f"quick-lead-{i}"].value = ""
            validate_lead_form(None); close_slide_over(None); render_leads(); document["success-msg"].text = f"Lead '{n}' saved!"; document["success_modal"].showModal()
            
        def update_form_fields(evt):
            dt = document["sales-type"].value
            for i, s in [("field-price", dt!="Delivery Note"), ("field-gst", dt!="Delivery Note"), ("field-status", dt not in ["Quotation", "Delivery Note", "Purchase Order"])]:
                document[i].style.display = "block" if s else "none"
            document["lbl-customer"].text = "Receiver" if dt=="Delivery Note" else "Customer"

        def download_backup(evt):
            data = {"ledger": [t.to_dict() for t in ledger], "inventory": inventory, "leads": leads}
            blob = window.Blob.new([window.JSON.stringify(data)], {'type': 'application/json'})
            link = html.A(href=window.URL.createObjectURL(blob), download="backup.json"); document <= link; link.click(); link.remove()

        def open_slide_over(evt): document["slide-over-panel"].classList.replace("closed", "open")
        def close_slide_over(evt): document["slide-over-panel"].classList.replace("open", "closed")

        def safe_bind(el_id, event, handler):
            try: document[el_id].bind(event, handler)
            except KeyError: pass

        def init():
            try:
                for v in ["dashboard", "create", "ledger", "receivables", "leads", "purchase", "payables", "inventory", "accounting", "gst", "utils"]:
                    safe_bind(f"nav-{v}", "click", lambda e, v=v: switch_view(f"view-{v}"))
                safe_bind("btn-login", "click", login_handler); safe_bind("btn-logout-sidebar", "click", logout_handler)
                safe_bind("btn-save-sales", "click", save_sales); safe_bind("btn-save-purchase", "click", save_purchase)
                safe_bind("theme-toggle-checkbox", "change", toggle_theme); safe_bind("sales-type", "change", update_form_fields)
                safe_bind("btn-user-roles", "click", open_roles_modal); safe_bind("btn-save-user", "click", save_new_user)
                for i in ["name", "mobile", "email", "comments"]: safe_bind(f"quick-lead-{i}", "input", validate_lead_form)
                safe_bind("btn-save-quick-lead", "click", save_quick_lead); safe_bind("btn-open-lead-panel", "click", open_slide_over); safe_bind("close-slide-over", "click", close_slide_over)
                safe_bind("btn-backup", "click", download_backup); safe_bind("fab-main-btn", "click", lambda e: document.select(".fab-menu")[0].classList.toggle("active"))
                safe_bind("fab-sales", "click", lambda e: [switch_view("view-create"), document.select(".fab-menu")[0].classList.remove("active")])
                safe_bind("fab-purchase", "click", lambda e: [switch_view("view-purchase"), document.select(".fab-menu")[0].classList.remove("active")])
                safe_bind("fab-lead", "click", lambda e: [open_slide_over(e), document.select(".fab-menu")[0].classList.remove("active")])

                global chart_main
                chart_main = window.Chart.new(document["mainChart"].getContext("2d"), {"type": "bar", "data": {"labels": ["Current"], "datasets": [{"label": "Sales", "data": [0], "backgroundColor": "#2d9ed8", "borderRadius": 8}, {"label": "Purch", "data": [0], "backgroundColor": "#8b5cf6", "borderRadius": 8}]}})
                window.Chart.new(document["pieChart"].getContext("2d"), {"type": "doughnut", "data": {"labels": ["Cash", "Credit"], "datasets": [{"data": [70, 30], "backgroundColor": ["#10b981", "#f59e0b"]}]}, "options": {"cutout": "70%"}})
                refresh_all(); document["loader"].style.display = "none"
            except Exception as e: document["loader-error"].innerHTML = f"<div class='bg-red-100 text-red-600 p-4 rounded-lg shadow font-mono text-sm max-w-lg'>Error: {str(e)}</div>"

        init()
    </script>
</body>
</html>
